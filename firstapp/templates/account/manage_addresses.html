{% extends 'base.html' %}
{% load static %}

{% block title %}Manage Addresses - WinnieCho{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/account/manage_addresses.css' %}">
{% endblock %}

{% block content %}
<!-- Page Title (Minimal) -->
<div class="page-title-jp">
    <div class="container-medium">
        <div class="title-content-jp">
            <h1 class="page-heading-jp">Address</h1>
            <p class="page-breadcrumb-jp">Dashboard /<br> Addresses</p>
        </div>
    </div>
</div>

<!-- Main Section -->
<section class="addresses-section-modern">
    <div class="container-modern">
        <!-- Header with Add Button -->
        <div class="section-header-modern">
            <div class="header-info">
                <h2>My Addresses</h2>
                <span class="address-count">{{ addresses|length }} saved</span>
            </div>
            <button class="btn-add-modern" onclick="openAddressModal()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                New Address
            </button>
        </div>

        <!-- Addresses Grid -->
        {% if addresses %}
        <div class="addresses-grid-modern">
            {% for address in addresses %}
            <div class="address-card-modern {% if address.is_default %}is-default{% endif %}">
                <!-- Card Header (No Emoji) -->
                <div class="card-header-modern">
                    <div class="label-wrapper">
                        <span class="label-text">{{ address.label }}</span>
                    </div>
                    {% if address.is_default %}
                    <span class="badge-default">Default</span>
                    {% endif %}
                </div>

                <!-- Card Body -->
                <div class="card-body-modern">
                    <p class="addr-name-modern">{{ address.user.name }}</p>
                    <p class="addr-line-modern">{{ address.address }}</p>
                    <p class="addr-city-modern">{{ address.city }}, {{ address.state }}</p>
                    <p class="addr-postal-modern">{{ address.postal_code }}</p>
                    <p class="addr-phone-modern">{{ address.user.phone }}</p>
                </div>

                <!-- Card Actions -->
                <div class="card-actions-modern">
                    {% if not address.is_default %}
                    <button class="btn-action-modern btn-default-modern" onclick="setDefaultAddress({{ address.id }})">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        Set Default
                    </button>
                    {% endif %}
                    <button class="btn-action-modern btn-edit-modern" onclick="editAddress({{ address.id }})">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                        Edit
                    </button>
                    <button class="btn-action-modern btn-delete-modern" onclick="deleteAddress({{ address.id }})">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>
                        </svg>
                        Delete
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state-modern">
            <div class="empty-icon"></div>
            <h3>No Addresses Yet</h3>
            <p>Add your first delivery address to get started</p>
            <button class="btn-empty-modern" onclick="openAddressModal()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Add First Address
            </button>
        </div>
        {% endif %}

        <!-- Back to Dashboard -->
        <div class="back-link-modern">
            {% if return_to_checkout %}
            <a href="{% url 'checkout' %}">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"/>
                </svg>
                Back to Checkout
            </a>
            {% else %}
            <a href="{% url 'dashboard' %}">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"/>
                </svg>
                Back to Dashboard
            </a>
            {% endif %}
        </div>
    </div>
</section>

<!-- Add/Edit Modal -->
<div class="modal-modern" id="addressModal">
    <div class="modal-overlay-modern" onclick="closeAddressModal()"></div>
    <div class="modal-content-modern">
        <div class="modal-header-modern">
            <h2 id="modalTitle">Add New Address</h2>
            <button class="modal-close-modern" onclick="closeAddressModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>

        <form id="addressForm" class="form-modern">
            {% csrf_token %}
            <input type="hidden" id="addressId" name="address_id">

            <div class="form-group-modern">
                <label>Address Label</label>
                <select id="label" name="label" required>
                    <option value="Home">Home</option>
                    <option value="Work">Work</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="form-group-modern">
                <label>Street Address</label>
                <textarea id="address" name="address" rows="2" placeholder="Enter your street address" required></textarea>
            </div>

            <div class="form-row-modern">
                <div class="form-group-modern">
                    <label>City</label>
                    <input type="text" id="city" name="city" placeholder="Enter city" required>
                </div>
                <div class="form-group-modern">
                    <label>Postal Code</label>
                    <input type="text" id="postal_code" name="postal_code" placeholder="12345" pattern="[0-9]{5}" required>
                </div>
            </div>

            <div class="form-group-modern">
                <label>State</label>
                <select id="state" name="state" required>
                    <option value="">Select State</option>
                    <option value="Johor">Johor</option>
                    <option value="Kedah">Kedah</option>
                    <option value="Kelantan">Kelantan</option>
                    <option value="Melaka">Melaka</option>
                    <option value="Negeri Sembilan">Negeri Sembilan</option>
                    <option value="Pahang">Pahang</option>
                    <option value="Penang">Penang</option>
                    <option value="Perak">Perak</option>
                    <option value="Perlis">Perlis</option>
                    <option value="Sabah">Sabah</option>
                    <option value="Sarawak">Sarawak</option>
                    <option value="Selangor">Selangor</option>
                    <option value="Terengganu">Terengganu</option>
                    <option value="WP Kuala Lumpur">WP Kuala Lumpur</option>
                    <option value="WP Labuan">WP Labuan</option>
                    <option value="WP Putrajaya">WP Putrajaya</option>
                </select>
            </div>

            <div class="form-checkbox-modern">
                <input type="checkbox" id="is_default" name="is_default">
                <label for="is_default">Set as default address</label>
            </div>

            <div class="form-actions-modern">
                <button type="button" class="btn-cancel-modern" onclick="closeAddressModal()">Cancel</button>
                <button type="submit" class="btn-submit-modern">Save Address</button>
            </div>
        </form>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Hidden Address Data for JS -->
<script id="addressData" type="application/json">
{
    {% for address in addresses %}
    "{{ address.id }}": {
        "id": {{ address.id }},
        "label": "{{ address.label }}",
        "address": "{{ address.address|escapejs }}",
        "city": "{{ address.city }}",
        "state": "{{ address.state }}",
        "postal_code": "{{ address.postal_code }}",
        "is_default": {{ address.is_default|yesno:"true,false" }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
}
</script>

<script src="{% static 'js/manage_addresses.js' %}"></script>
{% endblock %}