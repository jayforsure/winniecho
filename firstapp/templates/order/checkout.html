{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout - WinnieCho{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/order/checkout.css' %}">
{% endblock %}

{% block content %}
<div class="checkout-wrapper">
    <!-- Progress Steps -->
    <div class="checkout-progress">
        <div class="progress-container">
            <div class="progress-step active">
                <div class="step-circle">1</div>
                <span>Cart</span>
            </div>
            <div class="progress-line"></div>
            <div class="progress-step active current">
                <div class="step-circle">2</div>
                <span>Checkout</span>
            </div>
            <div class="progress-line"></div>
            <div class="progress-step">
                <div class="step-circle">3</div>
                <span>Payment</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="checkout-content">
        <!-- Left Column - Form -->
        <div class="checkout-main">
            <div class="section-card">
                <h2 class="section-title">Checkout</h2>
                
                <form id="checkoutForm" method="POST" action="{% url 'process_checkout' %}">
                    {% csrf_token %}
                    
                    <!-- Delivery Address -->
                    <div class="form-section">
                        <h3 class="subsection-title">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                <circle cx="12" cy="10" r="3"/>
                            </svg>
                            Delivery Address
                        </h3>
                        
                        {% if addresses.count > 0 %}
                        <div class="address-grid">
                            {% for addr in addresses %}
                            <label class="address-card {% if addr.is_default %}default{% endif %}">
                                <input type="radio" name="address_id" value="{{ addr.id }}" {% if addr.is_default %}checked{% endif %} required>
                                <div class="address-content">
                                    <div class="address-badges">
                                        {% if addr.is_default %}<span class="badge badge-primary">Default</span>{% endif %}
                                        <span class="badge badge-secondary">{{ addr.label }}</span>
                                    </div>
                                    <div class="address-info">
                                        <p class="name">{{ addr.user.name }}</p>
                                        <p class="details">{{ addr.address }}, {{ addr.city }}, {{ addr.state }} {{ addr.postal_code }}</p>
                                        <p class="phone">{{ addr.user.phone }}</p>
                                    </div>
                                </div>
                                <div class="check-indicator">✓</div>
                            </label>
                            {% endfor %}
                        </div>
                        <a href="{% url 'manage_addresses' %}?from=checkout" class="link-button">+ Add New Address</a>
                        {% else %}
                        <div class="empty-state">
                            <p>No saved addresses</p>
                            <a href="{% url 'manage_addresses' %}" class="btn-secondary">Add Address</a>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Loyalty Points -->
                    {% if member %}
                    <div class="form-section">
                        <h3 class="subsection-title">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                            </svg>
                            Loyalty Points
                        </h3>
                        
                        <div class="loyalty-card">
                            <div class="loyalty-info">
                                <div class="points-display">
                                    <span class="points-value">{{ member.loyalty_points|floatformat:2 }}</span>
                                    <span class="points-label">points</span>
                                </div>
                                <div class="points-worth">≈ RM {{ member.get_points_value|floatformat:2 }}</div>
                            </div>
                            <div class="loyalty-input-group">
                                <input 
                                    type="number" 
                                    id="loyalty_points_used" 
                                    name="loyalty_points_used"
                                    class="input-field"
                                    min="0" 
                                    max="{{ member.loyalty_points }}" 
                                    step="0.01"
                                    value="0"
                                    placeholder="Points to use">
                                <span class="input-note">1 point = RM 0.50</span>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Actions -->
                    <div class="form-actions">
                        <a href="{% url 'products' %}" class="btn-text">
                            ← Continue Shopping
                        </a>
                        <button type="submit" class="btn-primary">
                            Proceed to Payment 
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Right Column - Order Summary -->
        <div class="checkout-sidebar">
            <div class="section-card sticky">
                <h3 class="sidebar-title">Order Summary</h3>
                
                <div class="order-items">
                    {% for item in cart_items %}
                    <div class="order-item">
                        <div class="item-img">
                            {% with image=item.product.get_primary_image %}
                            {% if image %}
                            <img src="{{ image.image.url }}" alt="{{ item.product.name }}">
                            {% endif %}
                            {% endwith %}
                        </div>
                        <div class="item-info">
                            <p class="item-name">{{ item.product.name }}</p>
                            <p class="item-qty">Qty: {{ item.quantity }}</p>
                        </div>
                        <div class="item-price">RM {{ item.get_total_price|floatformat:2 }}</div>
                    </div>
                    {% empty %}
                    <p class="empty-text">No items</p>
                    {% endfor %}
                </div>
                
                <div class="order-totals">
                    <div class="total-line">
                        <span>Subtotal</span>
                        <span class="subtotal-value">RM {{ subtotal|floatformat:2 }}</span>
                    </div>
                    <div class="total-line final">
                        <span>Total</span>
                        <span class="total-value">RM {{ subtotal|floatformat:2 }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('checkoutForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const button = this.querySelector('button[type="submit"]');
    const originalHTML = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = 'Processing...';
    
    try {
        const response = await fetch('{% url "process_checkout" %}', {
            method: 'POST',
            headers: {'X-CSRFToken': formData.get('csrfmiddlewaretoken')},
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            window.location.href = data.redirect;
        } else {
            alert(data.error || 'Checkout failed');
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    } catch (error) {
        alert('Error: ' + error.message);
        button.disabled = false;
        button.innerHTML = originalHTML;
    }
});

if (member){ 
    loyaltyInput = document.getElementById('loyalty_points_used');
    subtotal = subtotal;
    const totalDisplay = document.querySelector('.total-value');

    loyaltyInput?.addEventListener('input', function() {
        let points = parseFloat(this.value) || 0;
        const maxPoints = member.loyalty_points;
        
        if (points > maxPoints) points = maxPoints;
        if (points < 0) points = 0;
        this.value = points;
        
        const discount = points * 0.5;
        const total = Math.max(0, subtotal - discount);
        
        if (totalDisplay) {
            totalDisplay.textContent = 'RM ' + total.toFixed(2);
        }
    });
}
</script>
{% endblock %}