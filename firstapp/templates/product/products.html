{% extends 'base.html' %}
{% load static %}

{% block title %}Collection - WinnieCho{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/product/products.css' %}">
{% endblock %}

{% block content %}
<!-- CSRF Token -->
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<!-- Page Title (Minimal) -->
<div class="page-title-jp">
    <div class="container-jp">
        <div class="title-content-jp">
            <h1 class="page-heading-jp">Collection</h1>
            <p class="page-breadcrumb-jp">Home / Collection</p>
        </div>
    </div>
</div>

<!-- Main Products Section (No Hero) -->
<section class="products-section-jp">
    <div class="container-jp">
        <!-- Elegant Sidebar Navigation -->
        <aside class="sidebar-jp">
            <!-- Categories -->
            <nav class="nav-block-jp">
                <h3 class="nav-title-jp">Collection</h3>
                <div class="nav-divider-jp"></div>
                <a href="#" class="nav-link-jpp {% if not selected_category %}active{% endif %}" data-category="">
                    <span class="nav-dot-jp"></span>
                    <span>All Products</span>
                </a>
                {% for category in categories %}
                <a href="#" class="nav-link-jpp {% if selected_category == category.code %}active{% endif %}" data-category="{{ category.code }}">
                    <span class="nav-dot-jp"></span>
                    <span>{{ category.name }}</span>
                </a>
                {% endfor %}
            </nav>

            <!-- Refined Sort -->
            <div class="sort-block-jp">
                <h3 class="nav-title-jp">Sort By</h3>
                <div class="nav-divider-jp"></div>
                <select id="sortSelect" class="select-jp">
                    <option value="">Default Order</option>
                    <option value="price_asc">Price: Low → High</option>
                    <option value="price_desc">Price: High → Low</option>
                    <option value="name_asc">Name: A → Z</option>
                    <option value="created_desc">Latest Arrivals</option>
                </select>
            </div>
        </aside>

        <!-- Products Main Area -->
        <main class="main-jp">
            <!-- Refined Search Bar -->
            <div class="search-container-jp">
                <div class="search-wrapper-jp">
                    <svg class="search-icon-jp" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                    <input type="text" id="searchInput" placeholder="Search our collection..." class="search-input-jp">
                </div>
                <div class="products-count-jp">
                    <span id="productCount">{{ products.count }}</span> items available
                </div>
            </div>

            <!-- Products Grid with Japanese Aesthetic -->
            <div class="products-grid-jp" id="productsGrid">
                {% for product in products %}
                <article class="product-card-jp" 
                         draggable="true"
                         data-product-id="{{ product.id }}"
                         data-product-name="{{ product.name }}"
                         data-product-price="{{ product.price }}"
                         data-product-stock="{{ product.stock }}"
                         data-product-category="{{ product.category.name }}">
                    
                    <!-- Drag Indicator (Minimalist) -->
                    <div class="drag-indicator-jp">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="9" cy="21" r="1"/>
                            <circle cx="20" cy="21" r="1"/>
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                        </svg>
                        <span>Add</span>
                    </div>

                    <!-- Product Image -->
                    <div class="product-image-container-jp">
                        {% with primary_image=product.get_primary_image %}
                        {% if primary_image %}
                        <img src="{{ primary_image.image.url }}" alt="{{ product.name }}" class="product-image-jp">
                        {% else %}
                        <div class="product-image-placeholder-jp"></div>
                        {% endif %}
                        {% endwith %}

                        <!-- Subtle Stock Badge -->
                        {% if product.stock <= 5 and product.stock > 0 %}
                        <span class="stock-badge-jp low">{{ product.stock }} left</span>
                        {% elif product.stock == 0 %}
                        <span class="stock-badge-jp out">Out</span>
                        {% endif %}
                    </div>

                    <!-- Product Info (Refined Typography) -->
                    <div class="product-info-jp">
                        <span class="category-badge-jp">{{ product.category.name }}</span>
                        <h3 class="product-name-jp">{{ product.name }}</h3>
                        
                        <div class="product-footer-jp">
                            <span class="product-price-jp">{{ product.price }}<small>RM</small></span>
                            <button class="btn-view-jp" onclick="showProductDetails('{{ product.id }}')">
                                Details
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M5 12h14"/>
                                    <path d="m12 5 7 7-7 7"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </article>
                {% endfor %}
            </div>
        </main>
    </div>
</section>

<!-- Minimalist Floating Cart (Start Minimized) -->
<div class="cart-floating-jp cart-minimized" id="floatingCart">
    <!-- Cart Header -->
    <div class="cart-header-jp" onclick="toggleCart()">
        <div class="cart-header-left-jp">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="9" cy="21" r="1"/>
                <circle cx="20" cy="21" r="1"/>
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
            </svg>
            <span>Cart</span>
        </div>
        <span class="cart-count-jp" id="cartCountBadge">0</span>
        <button class="cart-toggle-btn-jp">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"/>
            </svg>
        </button>
    </div>

    <!-- Cart Body -->
    <div class="cart-body-jp" id="cartBody">
        <!-- Dropzone (Minimalist) -->
        <div class="cart-dropzone-jp" id="cartDropzone">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                <circle cx="9" cy="21" r="1"/>
                <circle cx="20" cy="21" r="1"/>
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
            </svg>
            <p>Drag items here</p>
        </div>

        <!-- Cart Items -->
        <div class="cart-items-jp" id="cartItems">
            <!-- Items added via JS -->
        </div>
    </div>

    <!-- Cart Footer -->
    <div class="cart-footer-jp">
        <div class="cart-total-jp">
            <span>Total</span>
            <span class="total-amount-jp" id="cartTotal">0.00<small>RM</small></span>
        </div>
        <button class="btn-checkout-jp" onclick="proceedToCheckout()">
            Proceed to Checkout
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M5 12h14"/>
                <path d="m12 5 7 7-7 7"/>
            </svg>
        </button>
    </div>
</div>

<!-- Elegant Product Modal -->
<div class="modal-jp" id="productModal">
    <div class="modal-overlay-jp" onclick="closeProductModal()"></div>
    <div class="modal-content-jp">
        <!-- Close Button -->
        <button class="modal-close-jp" onclick="closeProductModal()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>

        <div class="modal-body-jp">
            <!-- Modal Gallery -->
            <div class="modal-gallery-jp">
                <div class="modal-main-image-jp">
                    <img id="modalMainImage" src="" alt="">
                </div>
                <div class="modal-thumbnails-jp" id="modalThumbnails">
                    <!-- Thumbnails via JS -->
                </div>
            </div>

            <!-- Modal Info -->
            <div class="modal-info-jp">
                <span class="modal-category-jp" id="modalCategory"></span>
                <h2 class="modal-title-jp" id="modalTitle"></h2>
                
                <div class="modal-price-line-jp">
                    <span class="modal-price-jp" id="modalPrice"></span>
                    <div class="modal-stock-jp" id="modalStock"></div>
                </div>

                <div class="modal-divider-jp"></div>

                <p class="modal-description-jp" id="modalDescription"></p>

                <!-- Refined Features -->
                <div class="modal-features-jp">
                    <div class="feature-item-jp">
                        <span class="feature-dot-jp"></span>
                        <span>Premium Quality</span>
                    </div>
                    <div class="feature-item-jp">
                        <span class="feature-dot-jp"></span>
                        <span>Handcrafted</span>
                    </div>
                    <div class="feature-item-jp">
                        <span class="feature-dot-jp"></span>
                        <span>Same Day Delivery</span>
                    </div>
                </div>

                <button class="btn-add-cart-jp" id="modalAddToCart">
                    Add to Cart
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="9" cy="21" r="1"/>
                        <circle cx="20" cy="21" r="1"/>
                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container (Minimalist) -->
<div class="toast-container-jp" id="toastContainer"></div>

<!-- Product Data -->
<script id="productData" type="application/json">
{
    {% for product in products %}
    "{{ product.id }}": {
        "id": "{{ product.id }}",
        "name": "{{ product.name }}",
        "price": "{{ product.price }}",
        "stock": {{ product.stock }},
        "category": "{{ product.category.name }}",
        "description": "{{ product.description|escapejs }}",
        "images": [
            {% for image in product.get_all_images %}
            "{{ image.image.url }}"{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
}
</script>

<script src="{% static 'js/products.js' %}"></script>
{% endblock %}